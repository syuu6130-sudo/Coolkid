-- ===================================
-- ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ« Rayfield Avatar Background
-- å…¨ã‚²ãƒ¼ãƒ ãƒ»å…¨ãƒãƒƒãƒ—å¯¾å¿œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
-- ===================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

-- === è¨­å®š ===
local CONFIG = {
    targetUsername = "jpneko03016",
    imageSize = 720,
    overlayTransparency = 0.6,
    overlayColor = Color3.fromRGB(0, 0, 0),
    zIndexBase = -100,
    retryAttempts = 3,
    retryDelay = 2
}

-- === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===
local function SafeWaitForChild(parent, childName, timeout)
    timeout = timeout or 10
    local startTime = tick()
    while not parent:FindFirstChild(childName) and (tick() - startTime) < timeout do
        task.wait(0.1)
    end
    return parent:FindFirstChild(childName)
end

local function IsValidPlayer()
    local player = Players.LocalPlayer
    return player and player:IsDescendantOf(game)
end

-- === èƒŒæ™¯ä½œæˆé–¢æ•° ===
local function CreateAvatarBackground()
    if not IsValidPlayer() then
        warn("âš ï¸ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç„¡åŠ¹ã§ã™")
        return false
    end

    local player = Players.LocalPlayer
    local playerGui = SafeWaitForChild(player, "PlayerGui", 15)
    
    if not playerGui then
        warn("âš ï¸ PlayerGuiãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™...")
        return false
    end

    -- æ—¢å­˜ã®GUIã‚’å‰Šé™¤
    local existing = playerGui:FindFirstChild("RayfieldAvatarBackground")
    if existing then
        existing:Destroy()
        task.wait(0.1)
    end

    -- ScreenGui ä½œæˆ
    local gui = Instance.new("ScreenGui")
    gui.Name = "RayfieldAvatarBackground"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.DisplayOrder = -1
    gui.Enabled = true
    
    -- å®‰å…¨ã«è¦ªè¨­å®š
    local success = pcall(function()
        gui.Parent = playerGui
    end)
    
    if not success then
        warn("âš ï¸ GUIä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ")
        return false
    end

    -- èƒŒæ™¯ã‚³ãƒ³ãƒ†ãƒŠ
    local container = Instance.new("Frame")
    container.Name = "Container"
    container.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    container.Size = UDim2.new(1, 0, 1, 0)
    container.Position = UDim2.new(0, 0, 0, 0)
    container.BorderSizePixel = 0
    container.ZIndex = CONFIG.zIndexBase
    container.Parent = gui

    -- ç”»åƒãƒ©ãƒ™ãƒ«
    local img = Instance.new("ImageLabel")
    img.Name = "AvatarImage"
    img.BackgroundTransparency = 1
    img.Size = UDim2.new(1, 0, 1, 0)
    img.Position = UDim2.new(0, 0, 0, 0)
    img.ScaleType = Enum.ScaleType.Crop
    img.ZIndex = CONFIG.zIndexBase + 1
    img.ImageTransparency = 1
    img.BorderSizePixel = 0
    img.Parent = container

    -- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
    local overlay = Instance.new("Frame")
    overlay.Name = "Overlay"
    overlay.BackgroundColor3 = CONFIG.overlayColor
    overlay.BackgroundTransparency = CONFIG.overlayTransparency
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BorderSizePixel = 0
    overlay.ZIndex = CONFIG.zIndexBase + 2
    overlay.Parent = container

    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
    local userId = nil
    for attempt = 1, CONFIG.retryAttempts do
        local success, result = pcall(function()
            return Players:GetUserIdFromNameAsync(CONFIG.targetUsername)
        end)
        
        if success then
            userId = result
            break
        else
            warn(string.format("âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—å¤±æ•— (è©¦è¡Œ %d/%d): %s", attempt, CONFIG.retryAttempts, tostring(result)))
            if attempt < CONFIG.retryAttempts then
                task.wait(CONFIG.retryDelay)
            end
        end
    end

    if not userId then
        warn("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")
        container.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        return false
    end

    -- ç”»åƒURLè¨­å®šï¼ˆè¤‡æ•°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    local imageUrls = {
        string.format("rbxthumb://type=AvatarHeadShot&id=%d&w=%d&h=%d", userId, CONFIG.imageSize, CONFIG.imageSize),
        string.format("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=%d&height=%d&format=png", userId, CONFIG.imageSize, CONFIG.imageSize),
        string.format("https://www.roblox.com/avatar-thumbnail/image?userId=%d&width=%d&height=%d&format=png", userId, CONFIG.imageSize, CONFIG.imageSize),
    }

    -- ç”»åƒèª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
    local imageLoaded = false
    for i, url in ipairs(imageUrls) do
        img.Image = url
        task.wait(0.5)
        
        if img.Image ~= "" then
            imageLoaded = true
            print(string.format("âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ (æ–¹æ³• %d): %s", i, CONFIG.targetUsername))
            break
        end
    end

    if not imageLoaded then
        warn("âš ï¸ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
    end

    -- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    task.spawn(function()
        task.wait(0.3)
        
        local tweenInfo = TweenInfo.new(
            0.8,
            Enum.EasingStyle.Quad,
            Enum.EasingDirection.Out
        )
        
        local tween = TweenService:Create(img, tweenInfo, {ImageTransparency = 0})
        tween:Play()
    end)

    return true
end

-- === Rayfield ãƒ­ãƒ¼ãƒ‰ï¼ˆå®‰å…¨ãªèª­ã¿è¾¼ã¿ï¼‰ ===
local Rayfield = nil
local rayfieldLoadSuccess = false

local function LoadRayfield()
    for attempt = 1, 3 do
        local success, result = pcall(function()
            return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
        end)
        
        if success then
            Rayfield = result
            rayfieldLoadSuccess = true
            print("âœ… Rayfieldèª­ã¿è¾¼ã¿æˆåŠŸ")
            return true
        else
            warn(string.format("âš ï¸ Rayfieldèª­ã¿è¾¼ã¿å¤±æ•— (è©¦è¡Œ %d/3): %s", attempt, tostring(result)))
            if attempt < 3 then
                task.wait(2)
            end
        end
    end
    
    warn("âŒ Rayfieldã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ")
    return false
end

-- === Rayfield UI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===
local function SetupRayfieldUI()
    if not rayfieldLoadSuccess or not Rayfield then
        warn("âŒ RayfieldãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ãŸã‚UIã‚’ä½œæˆã§ãã¾ã›ã‚“")
        return
    end

    local Window = Rayfield:CreateWindow({
        Name = "ğŸ¨ Universal Avatar Background",
        LoadingTitle = CONFIG.targetUsername .. " Avatar BG",
        LoadingSubtitle = "å…¨ã‚²ãƒ¼ãƒ å¯¾å¿œ by Sora",
        ConfigurationSaving = {
            Enabled = false
        }
    })

    local MainTab = Window:CreateTab("ğŸ  ãƒ¡ã‚¤ãƒ³", 4483362458)
    local SettingsTab = Window:CreateTab("âš™ï¸ è¨­å®š", 4483362458)
    
    -- === ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– ===
    MainTab:CreateSection("èƒŒæ™¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«")

    MainTab:CreateButton({
        Name = "ğŸ”„ èƒŒæ™¯ã‚’å†èª­ã¿è¾¼ã¿",
        Callback = function()
            local success = CreateAvatarBackground()
            if success then
                Rayfield:Notify({
                    Title = "âœ… å†èª­ã¿è¾¼ã¿å®Œäº†",
                    Content = "èƒŒæ™¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ",
                    Duration = 3,
                    Image = 4483362458,
                })
            else
                Rayfield:Notify({
                    Title = "âŒ å†èª­ã¿è¾¼ã¿å¤±æ•—",
                    Content = "èƒŒæ™¯ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ",
                    Duration = 3,
                    Image = 4483362458,
                })
            end
        end,
    })

    MainTab:CreateButton({
        Name = "ğŸ—‘ï¸ èƒŒæ™¯ã‚’å‰Šé™¤",
        Callback = function()
            local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
            local bg = playerGui:FindFirstChild("RayfieldAvatarBackground")
            if bg then
                bg:Destroy()
                Rayfield:Notify({
                    Title = "ğŸ—‘ï¸ å‰Šé™¤å®Œäº†",
                    Content = "èƒŒæ™¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
                    Duration = 3,
                    Image = 4483362458,
                })
            end
        end,
    })

    -- === è¨­å®šã‚¿ãƒ– ===
    SettingsTab:CreateSection("è¡¨ç¤ºè¨­å®š")

    SettingsTab:CreateSlider({
        Name = "ğŸŒ“ èƒŒæ™¯ã®æš—ã•",
        Range = {0, 1},
        Increment = 0.05,
        CurrentValue = CONFIG.overlayTransparency,
        Callback = function(value)
            CONFIG.overlayTransparency = value
            local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
            local bg = playerGui:FindFirstChild("RayfieldAvatarBackground")
            if bg then
                local overlay = bg:FindFirstChild("Container"):FindFirstChild("Overlay")
                if overlay then
                    overlay.BackgroundTransparency = value
                end
            end
        end,
    })

    SettingsTab:CreateInput({
        Name = "ğŸ‘¤ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å",
        PlaceholderText = CONFIG.targetUsername,
        RemoveTextAfterFocusLost = false,
        Callback = function(text)
            if text and text ~= "" then
                CONFIG.targetUsername = text
                Rayfield:Notify({
                    Title = "âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ›´æ–°",
                    Content = "æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼: " .. text,
                    Duration = 3,
                    Image = 4483362458,
                })
            end
        end,
    })

    SettingsTab:CreateSection("ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±")

    SettingsTab:CreateParagraph({
        Title = "â„¹ï¸ ç¾åœ¨ã®è¨­å®š",
        Content = string.format(
            "ãƒ¦ãƒ¼ã‚¶ãƒ¼: %s\nç”»åƒã‚µã‚¤ã‚º: %dx%d\nã‚²ãƒ¼ãƒ : %s",
            CONFIG.targetUsername,
            CONFIG.imageSize,
            CONFIG.imageSize,
            game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name
        )
    })

    -- åˆæœŸé€šçŸ¥
    Rayfield:Notify({
        Title = "âœ… ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†",
        Content = string.format("%s ã®èƒŒæ™¯ã‚’è¨­å®šã—ã¾ã—ãŸ\nå…¨ã‚²ãƒ¼ãƒ å¯¾å¿œãƒ¢ãƒ¼ãƒ‰", CONFIG.targetUsername),
        Duration = 6,
        Image = 4483362458,
    })
end

-- === ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ ===
local function Initialize()
    print("ğŸš€ ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«èƒŒæ™¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆèµ·å‹•ä¸­...")
    
    -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¾…æ©Ÿ
    if not IsValidPlayer() then
        repeat task.wait(0.5) until IsValidPlayer()
    end
    
    print("âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ¤œå‡º")
    
    -- èƒŒæ™¯ä½œæˆ
    local bgSuccess = false
    for attempt = 1, CONFIG.retryAttempts do
        print(string.format("ğŸ¨ èƒŒæ™¯ä½œæˆè©¦è¡Œ %d/%d", attempt, CONFIG.retryAttempts))
        bgSuccess = CreateAvatarBackground()
        if bgSuccess then
            break
        end
        if attempt < CONFIG.retryAttempts then
            task.wait(CONFIG.retryDelay)
        end
    end
    
    if bgSuccess then
        print("âœ… èƒŒæ™¯ä½œæˆæˆåŠŸ")
    else
        warn("âš ï¸ èƒŒæ™¯ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ç¶™ç¶šã—ã¾ã™")
    end
    
    -- Rayfieldèª­ã¿è¾¼ã¿
    task.wait(0.5)
    if LoadRayfield() then
        SetupRayfieldUI()
    end
end

-- === ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆãƒªã‚¹ãƒãƒ¼ãƒ³å¯¾å¿œï¼‰ ===
if IsValidPlayer() then
    Players.LocalPlayer.CharacterAdded:Connect(function()
        task.wait(1)
        print("ğŸ”„ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒãƒ¼ãƒ³æ¤œå‡ºã€èƒŒæ™¯å†ä½œæˆ...")
        CreateAvatarBackground()
    end)
end

-- === å®Ÿè¡Œ ===
Initialize()

print("âœ… ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«èƒŒæ™¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Œå…¨èµ·å‹•")
