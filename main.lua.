-- âœ… ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«å¯¾å¿œç‰ˆ with Rayfield UI
-- ğŸŒ å…¨ã‚²ãƒ¼ãƒ ãƒ»å…¨ãƒãƒƒãƒ—å¯¾å¿œæ©Ÿèƒ½

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- è¨­å®š
local CONFIG = {
    MAX_RETRIES = 3,
    RETRY_DELAY = 1,
    TIMEOUT = 10,
    IMAGE_URLS = {
        "rbxassetid://YOUR_IMAGE_ID_1",
        "rbxassetid://YOUR_IMAGE_ID_2",
        "rbxassetid://YOUR_IMAGE_ID_3"
    }
}

-- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
local State = {
    isInitialized = false,
    currentBackground = nil,
    logs = {},
    stats = {
        initAttempts = 0,
        errors = 0,
        lastUpdate = os.time()
    }
}

-- ğŸ”§ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
local function Log(message, level)
    level = level or "INFO"
    local timestamp = os.date("%H:%M:%S")
    local logEntry = string.format("[%s][%s] %s", timestamp, level, message)
    table.insert(State.logs, logEntry)
    print(logEntry)
    
    -- æœ€å¤§100ä»¶ã®ãƒ­ã‚°ã‚’ä¿æŒ
    if #State.logs > 100 then
        table.remove(State.logs, 1)
    end
end

local function SafeCall(func, context)
    local success, result = pcall(func)
    if not success then
        State.stats.errors = State.stats.errors + 1
        Log(string.format("%s ã‚¨ãƒ©ãƒ¼: %s", context, tostring(result)), "ERROR")
        return false, result
    end
    return true, result
end

-- ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ©Ÿèƒ½
local function LoadImageWithRetry(imageLabel)
    for attempt = 1, CONFIG.MAX_RETRIES do
        for _, url in ipairs(CONFIG.IMAGE_URLS) do
            local success = SafeCall(function()
                imageLabel.Image = url
            end, "ç”»åƒèª­ã¿è¾¼ã¿")
            
            if success then
                Log(string.format("ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ: %s (è©¦è¡Œ: %d)", url, attempt), "SUCCESS")
                return true
            end
            
            task.wait(CONFIG.RETRY_DELAY)
        end
    end
    
    Log("ã™ã¹ã¦ã®ç”»åƒURLãŒå¤±æ•—ã—ã¾ã—ãŸ", "ERROR")
    return false
end

-- ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆæœŸåŒ–
local function WaitForPlayerGui(timeout)
    local player = Players.LocalPlayer
    local startTime = tick()
    
    while not player:FindFirstChild("PlayerGui") do
        if tick() - startTime > timeout then
            Log("PlayerGui ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ", "ERROR")
            return nil
        end
        task.wait(0.1)
    end
    
    Log("PlayerGui æ¤œå‡ºæˆåŠŸ", "SUCCESS")
    return player.PlayerGui
end

-- ğŸ—‘ï¸ æ—¢å­˜GUIå‰Šé™¤
local function RemoveExistingGUI()
    local success = SafeCall(function()
        local playerGui = Players.LocalPlayer.PlayerGui
        if playerGui:FindFirstChild("UniversalBackgroundGUI") then
            playerGui.UniversalBackgroundGUI:Destroy()
            Log("æ—¢å­˜GUIå‰Šé™¤å®Œäº†", "INFO")
        end
    end, "æ—¢å­˜GUIå‰Šé™¤")
    
    return success
end

-- ğŸ–¼ï¸ èƒŒæ™¯ä½œæˆ
local function CreateBackground()
    RemoveExistingGUI()
    
    local success, gui = SafeCall(function()
        local playerGui = Players.LocalPlayer.PlayerGui
        
        -- ScreenGuiä½œæˆ
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "UniversalBackgroundGUI"
        screenGui.DisplayOrder = -1
        screenGui.ResetOnSpawn = false
        screenGui.IgnoreGuiInset = true
        screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        
        -- èƒŒæ™¯Frame
        local background = Instance.new("Frame")
        background.Name = "Background"
        background.Size = UDim2.new(1, 0, 1, 0)
        background.Position = UDim2.new(0, 0, 0, 0)
        background.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
        background.BorderSizePixel = 0
        background.ZIndex = -1
        background.Parent = screenGui
        
        -- ç”»åƒLabel
        local imageLabel = Instance.new("ImageLabel")
        imageLabel.Name = "BackgroundImage"
        imageLabel.Size = UDim2.new(1, 0, 1, 0)
        imageLabel.Position = UDim2.new(0, 0, 0, 0)
        imageLabel.BackgroundTransparency = 1
        imageLabel.ScaleType = Enum.ScaleType.Stretch
        imageLabel.ZIndex = -1
        imageLabel.Parent = background
        
        screenGui.Parent = playerGui
        
        -- ç”»åƒèª­ã¿è¾¼ã¿
        LoadImageWithRetry(imageLabel)
        
        return screenGui
    end, "èƒŒæ™¯ä½œæˆ")
    
    if success then
        State.currentBackground = gui
        Log("èƒŒæ™¯ä½œæˆæˆåŠŸ", "SUCCESS")
        return true
    end
    
    return false
end

-- ğŸš€ ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–
local function Initialize()
    State.stats.initAttempts = State.stats.initAttempts + 1
    Log(string.format("åˆæœŸåŒ–é–‹å§‹ (è©¦è¡Œ: %d)", State.stats.initAttempts), "INFO")
    
    -- PlayerGuiå¾…æ©Ÿ
    local playerGui = WaitForPlayerGui(CONFIG.TIMEOUT)
    if not playerGui then
        return false
    end
    
    -- èƒŒæ™¯ä½œæˆ
    if CreateBackground() then
        State.isInitialized = true
        Log("åˆæœŸåŒ–å®Œäº†", "SUCCESS")
        return true
    end
    
    return false
end

-- ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—
local function GetSystemInfo()
    local player = Players.LocalPlayer
    return {
        Username = player.Name,
        DisplayName = player.DisplayName,
        UserId = player.UserId,
        GameName = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name,
        PlaceId = game.PlaceId,
        FPS = math.floor(1 / RunService.RenderStepped:Wait()),
        Ping = math.floor(player:GetNetworkPing() * 1000),
        InitAttempts = State.stats.initAttempts,
        Errors = State.stats.errors,
        BackgroundActive = State.currentBackground ~= nil
    }
end

-- ğŸ¨ Rayfield UIä½œæˆ
local function CreateRayfieldUI()
    Log("Rayfield UIèª­ã¿è¾¼ã¿é–‹å§‹", "INFO")
    
    local success, Rayfield = SafeCall(function()
        return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
    end, "Rayfieldèª­ã¿è¾¼ã¿")
    
    if not success then
        Log("Rayfieldèª­ã¿è¾¼ã¿å¤±æ•—", "ERROR")
        return
    end
    
    Log("Rayfield UIèª­ã¿è¾¼ã¿æˆåŠŸ", "SUCCESS")
    
    -- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½œæˆ
    local Window = Rayfield:CreateWindow({
        Name = "ğŸŒ ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«èƒŒæ™¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼",
        LoadingTitle = "åˆæœŸåŒ–ä¸­...",
        LoadingSubtitle = "by Universal System",
        ConfigurationSaving = {
            Enabled = false
        },
        Discord = {
            Enabled = false
        },
        KeySystem = false
    })
    
    -- ğŸ  ãƒ›ãƒ¼ãƒ ã‚¿ãƒ–
    local HomeTab = Window:CreateTab("ğŸ  ãƒ›ãƒ¼ãƒ ", 4483362458)
    
    HomeTab:CreateSection("ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹")
    
    local StatusLabel = HomeTab:CreateLabel("çŠ¶æ…‹: åˆæœŸåŒ–ä¸­...")
    
    HomeTab:CreateButton({
        Name = "ğŸ”„ èƒŒæ™¯ã‚’å†èª­ã¿è¾¼ã¿",
        Callback = function()
            Log("èƒŒæ™¯å†èª­ã¿è¾¼ã¿é–‹å§‹", "INFO")
            CreateBackground()
            StatusLabel:Set("çŠ¶æ…‹: èƒŒæ™¯å†èª­ã¿è¾¼ã¿å®Œäº† âœ…")
            Rayfield:Notify({
                Title = "æˆåŠŸ",
                Content = "èƒŒæ™¯ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ",
                Duration = 3,
                Image = 4483362458
            })
        end
    })
    
    HomeTab:CreateButton({
        Name = "ğŸ—‘ï¸ èƒŒæ™¯ã‚’å‰Šé™¤",
        Callback = function()
            if State.currentBackground then
                State.currentBackground:Destroy()
                State.currentBackground = nil
                Log("èƒŒæ™¯å‰Šé™¤å®Œäº†", "INFO")
                StatusLabel:Set("çŠ¶æ…‹: èƒŒæ™¯å‰Šé™¤æ¸ˆã¿ âŒ")
                Rayfield:Notify({
                    Title = "å‰Šé™¤å®Œäº†",
                    Content = "èƒŒæ™¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
                    Duration = 3,
                    Image = 4483362458
                })
            else
                Rayfield:Notify({
                    Title = "ã‚¨ãƒ©ãƒ¼",
                    Content = "å‰Šé™¤ã™ã‚‹èƒŒæ™¯ãŒã‚ã‚Šã¾ã›ã‚“",
                    Duration = 3,
                    Image = 4483362458
                })
            end
        end
    })
    
    -- âš™ï¸ è¨­å®šã‚¿ãƒ–
    local SettingsTab = Window:CreateTab("âš™ï¸ è¨­å®š", 4483362458)
    
    SettingsTab:CreateSection("ç”»åƒè¨­å®š")
    
    SettingsTab:CreateInput({
        Name = "ã‚«ã‚¹ã‚¿ãƒ ç”»åƒID",
        PlaceholderText = "rbxassetid://123456789",
        RemoveTextAfterFocusLost = false,
        Callback = function(text)
            if text and text ~= "" then
                table.insert(CONFIG.IMAGE_URLS, 1, text)
                LoadImageWithRetry(State.currentBackground.Background.BackgroundImage)
                Log("ã‚«ã‚¹ã‚¿ãƒ ç”»åƒé©ç”¨: " .. text, "INFO")
                Rayfield:Notify({
                    Title = "ç”»åƒæ›´æ–°",
                    Content = "ã‚«ã‚¹ã‚¿ãƒ ç”»åƒã‚’é©ç”¨ã—ã¾ã—ãŸ",
                    Duration = 3,
                    Image = 4483362458
                })
            end
        end
    })
    
    SettingsTab:CreateSlider({
        Name = "èƒŒæ™¯é€æ˜åº¦",
        Range = {0, 1},
        Increment = 0.1,
        CurrentValue = 1,
        Callback = function(value)
            if State.currentBackground then
                State.currentBackground.Background.BackgroundImage.ImageTransparency = 1 - value
            end
        end
    })
    
    -- ğŸ“Š çµ±è¨ˆã‚¿ãƒ–
    local StatsTab = Window:CreateTab("ğŸ“Š çµ±è¨ˆ", 4483362458)
    
    StatsTab:CreateSection("ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±")
    
    local InfoLabel = StatsTab:CreateLabel("èª­ã¿è¾¼ã¿ä¸­...")
    
    StatsTab:CreateButton({
        Name = "ğŸ”„ æƒ…å ±æ›´æ–°",
        Callback = function()
            local info = GetSystemInfo()
            local infoText = string.format(
                "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: %s (@%s)\n" ..
                "ğŸ†” ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: %d\n" ..
                "ğŸ® ã‚²ãƒ¼ãƒ : %s\n" ..
                "ğŸ“ PlaceID: %d\n" ..
                "ğŸ–¥ï¸ FPS: %d\n" ..
                "ğŸ“¡ Ping: %dms\n" ..
                "ğŸ”„ åˆæœŸåŒ–è©¦è¡Œ: %då›\n" ..
                "âŒ ã‚¨ãƒ©ãƒ¼æ•°: %d\n" ..
                "ğŸ–¼ï¸ èƒŒæ™¯: %s",
                info.DisplayName, info.Username, info.UserId,
                info.GameName, info.PlaceId,
                info.FPS, info.Ping,
                info.InitAttempts, info.Errors,
                info.BackgroundActive and "æœ‰åŠ¹ âœ…" or "ç„¡åŠ¹ âŒ"
            )
            InfoLabel:Set(infoText)
        end
    })
    
    -- ğŸ“ ãƒ­ã‚°ã‚¿ãƒ–
    local LogTab = Window:CreateTab("ğŸ“ ãƒ­ã‚°", 4483362458)
    
    LogTab:CreateSection("ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°")
    
    local LogLabel = LogTab:CreateLabel("ãƒ­ã‚°ãªã—")
    
    LogTab:CreateButton({
        Name = "ğŸ“‹ ãƒ­ã‚°è¡¨ç¤º",
        Callback = function()
            if #State.logs > 0 then
                local recentLogs = {}
                for i = math.max(1, #State.logs - 10), #State.logs do
                    table.insert(recentLogs, State.logs[i])
                end
                LogLabel:Set(table.concat(recentLogs, "\n"))
            else
                LogLabel:Set("ãƒ­ã‚°ãªã—")
            end
        end
    })
    
    LogTab:CreateButton({
        Name = "ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢",
        Callback = function()
            State.logs = {}
            LogLabel:Set("ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
            Rayfield:Notify({
                Title = "ã‚¯ãƒªã‚¢å®Œäº†",
                Content = "ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ",
                Duration = 2,
                Image = 4483362458
            })
        end
    })
    
    -- åˆæœŸçŠ¶æ…‹æ›´æ–°
    if State.isInitialized then
        StatusLabel:Set("çŠ¶æ…‹: åˆæœŸåŒ–å®Œäº† âœ…")
    end
    
    Log("Rayfield UIä½œæˆå®Œäº†", "SUCCESS")
end

-- ğŸš€ ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
task.spawn(function()
    Log("=== ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ã‚·ã‚¹ãƒ†ãƒ èµ·å‹• ===", "INFO")
    
    -- åˆæœŸåŒ–ãƒªãƒˆãƒ©ã‚¤
    local initSuccess = false
    for attempt = 1, CONFIG.MAX_RETRIES do
        if Initialize() then
            initSuccess = true
            break
        end
        Log(string.format("åˆæœŸåŒ–å¤±æ•—ã€å†è©¦è¡Œä¸­... (%d/%d)", attempt, CONFIG.MAX_RETRIES), "WARN")
        task.wait(CONFIG.RETRY_DELAY)
    end
    
    if not initSuccess then
        Log("åˆæœŸåŒ–å¤±æ•—: æœ€å¤§è©¦è¡Œå›æ•°ã‚’è¶…ãˆã¾ã—ãŸ", "ERROR")
    end
    
    -- Rayfield UIä½œæˆ
    task.wait(0.5)
    CreateRayfieldUI()
    
    Log("=== ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº† ===", "SUCCESS")
end)

-- ãƒªã‚¹ãƒãƒ¼ãƒ³å¯¾å¿œ
Players.LocalPlayer.CharacterAdded:Connect(function()
    Log("ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒªã‚¹ãƒãƒ¼ãƒ³æ¤œå‡º", "INFO")
    task.wait(1)
    if not State.currentBackground then
        CreateBackground()
    end
end)
