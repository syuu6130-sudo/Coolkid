-- Rayfield Library ã‚’ãƒ­ãƒ¼ãƒ‰
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- === è¨­å®š ===
local CONFIG = {
    targetUsername = "jpneko03016",
    imageSize = 720,
    overlayTransparency = 0.6,  -- 0-1 (å¤§ãã„ã»ã©æš—ã„)
    overlayColor = Color3.fromRGB(0, 0, 0),
    zIndexBase = -100  -- è² ã®å€¤ã§Rayfield UIã®ä¸‹ã«é…ç½®
}

-- === èƒŒæ™¯ç”¨é–¢æ•° ===
local function CreateAvatarBackground()
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")

    -- æ—¢å­˜ã®GUIã‚’å‰Šé™¤
    local existing = playerGui:FindFirstChild("RayfieldAvatarBackground")
    if existing then
        existing:Destroy()
    end

    -- ScreenGui ä½œæˆ
    local gui = Instance.new("ScreenGui")
    gui.Name = "RayfieldAvatarBackground"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.DisplayOrder = -1  -- Rayfieldã‚ˆã‚Šå¾Œã‚ã«é…ç½®
    gui.Parent = playerGui

    -- èƒŒæ™¯ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰
    local container = Instance.new("Frame")
    container.Name = "Container"
    container.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    container.Size = UDim2.new(1, 0, 1, 0)
    container.Position = UDim2.new(0, 0, 0, 0)
    container.ZIndex = CONFIG.zIndexBase
    container.Parent = gui

    -- ç”»åƒãƒ©ãƒ™ãƒ«ä½œæˆ
    local img = Instance.new("ImageLabel")
    img.Name = "AvatarImage"
    img.BackgroundTransparency = 1
    img.Size = UDim2.new(1, 0, 1, 0)
    img.Position = UDim2.new(0, 0, 0, 0)
    img.ScaleType = Enum.ScaleType.Crop
    img.ZIndex = CONFIG.zIndexBase + 1
    img.ImageTransparency = 1  -- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ç”¨
    img.Parent = container

    -- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆèƒŒæ™¯ã‚’æš—ãã™ã‚‹ï¼‰
    local overlay = Instance.new("Frame")
    overlay.Name = "Overlay"
    overlay.BackgroundColor3 = CONFIG.overlayColor
    overlay.BackgroundTransparency = CONFIG.overlayTransparency
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.ZIndex = CONFIG.zIndexBase + 2
    overlay.Parent = container

    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    local success, result = pcall(function()
        return Players:GetUserIdFromNameAsync(CONFIG.targetUsername)
    end)

    if not success then
        warn("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—å¤±æ•—:", result)
        -- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯è‰²ã‚’è¡¨ç¤º
        container.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        return false
    end

    local userId = result
    
    -- ç”»åƒURLã‚’è¨­å®šï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦è¡Œï¼‰
    local imageUrls = {
        -- æ–¹æ³•1: Thumbnail API
        string.format(
            "https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=%d&height=%d&format=png",
            userId, CONFIG.imageSize, CONFIG.imageSize
        ),
        -- æ–¹æ³•2: Avatar thumbnail (ãƒ•ãƒ«ãƒœãƒ‡ã‚£)
        string.format(
            "https://www.roblox.com/avatar-thumbnail/image?userId=%d&width=%d&height=%d&format=png",
            userId, CONFIG.imageSize, CONFIG.imageSize
        ),
        -- æ–¹æ³•3: rbxthumb ãƒ—ãƒ­ã‚­ã‚·
        string.format(
            "rbxthumb://type=AvatarHeadShot&id=%d&w=%d&h=%d",
            userId, CONFIG.imageSize, CONFIG.imageSize
        )
    }

    -- æœ€åˆã®URLã‚’è©¦ã™
    img.Image = imageUrls[1]

    -- ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    task.spawn(function()
        task.wait(0.5)  -- ç”»åƒèª­ã¿è¾¼ã¿å¾…æ©Ÿ
        
        local tweenInfo = TweenInfo.new(
            0.8,  -- æ™‚é–“
            Enum.EasingStyle.Quad,
            Enum.EasingDirection.Out
        )
        
        local tween = game:GetService("TweenService"):Create(
            img,
            tweenInfo,
            {ImageTransparency = 0}
        )
        
        tween:Play()
    end)

    print("âœ… èƒŒæ™¯ã«ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¨­å®š: " .. CONFIG.targetUsername)
    return true
end

-- === Rayfield UI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ===
local function SetupRayfieldUI()
    local Window = Rayfield:CreateWindow({
        Name = "ğŸ¨ Rayfield Avatar Background",
        LoadingTitle = CONFIG.targetUsername .. " Avatar Background",
        LoadingSubtitle = "by Sora",
        ConfigurationSaving = {
            Enabled = false
        }
    })

    local MainTab = Window:CreateTab("ğŸ  Main", 4483362458)
    local Section = MainTab:CreateSection("èƒŒæ™¯è¨­å®š")

    -- èƒŒæ™¯å†èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
    MainTab:CreateButton({
        Name = "ğŸ”„ èƒŒæ™¯ã‚’å†èª­ã¿è¾¼ã¿",
        Callback = function()
            CreateAvatarBackground()
            Rayfield:Notify({
                Title = "å†èª­ã¿è¾¼ã¿å®Œäº†",
                Content = "èƒŒæ™¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ",
                Duration = 3,
                Image = 4483362458,
            })
        end,
    })

    -- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    MainTab:CreateSlider({
        Name = "ğŸŒ“ èƒŒæ™¯ã®æš—ã•",
        Range = {0, 1},
        Increment = 0.05,
        CurrentValue = CONFIG.overlayTransparency,
        Callback = function(value)
            CONFIG.overlayTransparency = value
            local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
            local bg = playerGui:FindFirstChild("RayfieldAvatarBackground")
            if bg then
                local overlay = bg:FindFirstChild("Container"):FindFirstChild("Overlay")
                if overlay then
                    overlay.BackgroundTransparency = value
                end
            end
        end,
    })

    -- æƒ…å ±è¡¨ç¤º
    MainTab:CreateParagraph({
        Title = "â„¹ï¸ æƒ…å ±",
        Content = "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼: " .. CONFIG.targetUsername .. "\nç”»åƒã‚µã‚¤ã‚º: " .. CONFIG.imageSize .. "x" .. CONFIG.imageSize
    })

    -- åˆæœŸé€šçŸ¥
    Rayfield:Notify({
        Title = "âœ… èƒŒæ™¯è¨­å®šå®Œäº†",
        Content = CONFIG.targetUsername .. " ã®ã‚¢ãƒã‚¿ãƒ¼ã‚’èƒŒæ™¯ã«è¨­å®šã—ã¾ã—ãŸ",
        Duration = 5,
        Image = 4483362458,
    })
end

-- === å®Ÿè¡Œ ===
local bgSuccess = CreateAvatarBackground()

if bgSuccess then
    task.wait(0.5)  -- èƒŒæ™¯ãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…æ©Ÿ
end

SetupRayfieldUI()

-- === ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒªã‚¹ãƒãƒ¼ãƒ³ã—ãŸæ™‚ï¼‰===
Players.LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    CreateAvatarBackground()
end)
